#!/usr/bin/env bash

if [ "$EUID" -ne 0 ]; then
    exec sudo "$(command -v "$0")" "$@"
fi

source "$(dirname "$0")/brightness_common.sh"

device_paths=(
    "/sys/class/backlight/appletb_backlight"
)

device_path=$(find_device_path "${device_paths[@]}")

if [ -z "$device_path" ]; then
    echo -e "${RED}Error: No suitable touchbar backlight device found.${RESET}" >&2
    exit 1
fi

percentage_input="$1"
numeric_percentage=${percentage_input//%}

if ! [[ "$numeric_percentage" =~ ^[0-9]+$ ]]; then
    echo -e "${RED}Error: Invalid percentage value provided. Please use a number (e.g., 50 or 50%).${RESET}" >&2
    echo -e "${YELLOW}Usage: $0 <percentage>${RESET}" >&2
    exit 1
fi

if [ "$numeric_percentage" -lt 0 ] || [ "$numeric_percentage" -gt 100 ]; then
    echo -e "${RED}Error: Percentage must be between 0 and 100.${RESET}" >&2
    exit 1
fi

raw_level=""
if [ "$numeric_percentage" -eq 0 ]; then
    raw_level=0
elif [ "$numeric_percentage" -ge 1 ] && [ "$numeric_percentage" -le 49 ]; then
    raw_level=1
elif [ "$numeric_percentage" -ge 50 ] && [ "$numeric_percentage" -le 100 ]; then
    raw_level=2
fi

apply_brightness_raw "$raw_level" "$device_path"
exit $?