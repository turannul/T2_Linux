#!/usr/bin/env bash

if [ "$EUID" -ne 0 ]; then
    exec sudo "$(command -v "$0")" "$@"
fi

cmd_date=$(command -v date)
cmd_printf=$(command -v printf)
cmd_tee=$(command -v tee)
cmd_lsmod=$(command -v lsmod)
cmd_grep=$(command -v grep)
cmd_modprobe=$(command -v modprobe)
cmd_sleep=$(command -v sleep)
cmd_rmmod=$(command -v rmmod)
cmd_systemctl=$(command -v systemctl)

log_file="$HOME/.cache/suspend-fix-t2.log"

function log() {
	local log_level="$1"
	local event_msg="$2"
	local timestamp
	timestamp=$($cmd_date "+%Y-%m-%d %H:%M:%S")
	local level_str="INFO"

	case "$log_level" in
	"-")
		level_str="ERROR"
		;;
	"!")
		level_str="WARNING"
		;;
	"*")
		level_str="INFO"
		;;
	"#")
		level_str="DEBUG"
		;;
	*)
		level_str="INFO"
		;;
	esac

	$cmd_printf "[$timestamp] [$level_str] $event_msg\n" | $cmd_tee --append "$log_file"
}

function _load_module() {
	module_name="${1//-/_}"
	delay="${2:-0.5}"

	if $cmd_lsmod | $cmd_grep -q "^$module_name\\s"; then
		log "!" "Module $1 is already loaded."
		return 0
	fi

	log "*" "Module $1 is not loaded. Loading..."
	$cmd_modprobe "$1"
	log "*" "Waiting ${delay}s for initialization..."
	$cmd_sleep "$delay"

	if $cmd_lsmod | $cmd_grep -q "^$module_name\\s"; then
		log "*" "Module $1 loaded successfully."
		return 0
	fi

	log "-" "Failed to load module $1."
	return 1
}

function _unload_module() {
	module_name="${1//-/_}"
	delay="${2:-0.5}"

	if ! $cmd_lsmod | $cmd_grep -q "^$module_name\\s"; then
		log "!" "Module $1 is not loaded, skipping."
		return 0
	fi

	log "*" "Module $1 is loaded. Unloading..."
	if [ "$1" == "apple-bce" ] || [ "$module_name" == "apple_bce" ]; then
		$cmd_rmmod "$1"
	else
		$cmd_modprobe --remove --remove-holders "$1"
	fi

	log "*" "Waiting ${delay}s for deinitialization..."
	$cmd_sleep "$delay"

	if ! $cmd_lsmod | $cmd_grep -q "^$module_name\\s"; then
		log "*" "Module $1 unloaded successfully."
		return 0
	fi

	log "-" "Failed to unload module $1."
	return 1
}

function _stop_service() {
	service_name=$1
	if $cmd_systemctl is-active --quiet "$service_name"; then
		log "*" "Stopping $service_name..."
		$cmd_systemctl stop "$service_name"
	fi
}

function _start_service() {
	service_name=$1
	wait_arg="${2:-wait}"

	ctl_args=""
	if [ "$wait_arg" == "no-wait" ]; then
		ctl_args="--no-block"
	fi

	if ! $cmd_systemctl is-active --quiet "$service_name"; then
		log "*" "Starting $service_name..."
		$cmd_systemctl start $ctl_args "$service_name"
	else
		log "*" "$service_name is already running, Restarting..."
		log "*" "Restarting $service_name..."
		$cmd_systemctl restart $ctl_args "$service_name"
	fi
}

function _rescan_PCI() {
	log "*" "Rescanning PCI bus..."
	if echo 1 > /sys/bus/pci/rescan; then
		log "*" "PCI rescan triggered successfully."
	else
		log "-" "Failed to trigger PCI rescan."
	fi
}

function _unbind_device() {
	local device_id="$1"
	local device_name="${2:-device $device_id}"
	local unbind_path="/sys/bus/pci/devices/$device_id/driver/unbind"

	if [ -w "$unbind_path" ]; then
		log "*" "Unbinding $device_name..."
		if echo "$device_id" > "$unbind_path" 2>/dev/null; then
			if [ ! -e "/sys/bus/pci/devices/$device_id/driver" ]; then
				log "*" "Unbound $device_name successfully."
				return 0
			fi
		fi
		log "-" "Failed to unbind $device_name."
	else
		log "!" "$device_name is not bound or not found."
	fi
}

function _remove_device() {
	local device_id="$1"
	local device_name="${2:-device $device_id}"
	local remove_path="/sys/bus/pci/devices/$device_id/remove"

	if [ -w "$remove_path" ]; then
		log "*" "Removing $device_name..."
		if echo 1 > "$remove_path" 2>/dev/null; then
			if [ ! -e "/sys/bus/pci/devices/$device_id" ]; then
				log "*" "Removed $device_name successfully."
				return 0
			fi
		fi
		log "-" "Failed to remove $device_name."
	else
		log "!" "$device_name not found, skipping removal."
	fi
}

function load() {
	log "_" "###########################"
	log "*" "Executing load sequence..."
	log "_" "###########################"

	_load_module apple-bce 4
	_load_module hid_appletb_bl
	_load_module hid_appletb_kbd
	_load_module appletbdrm
	_load_module brcmfmac 1
	_load_module brcmfmac_wcc 2
	_load_module hci_bcm4377 1
	_start_service tiny-dfr.service no-wait
	_rescan_PCI
	_load_module thunderbolt
}

function unload() {
	log "_" "###########################"
	log "*" "Executing unload sequence..."
	log "_" "###########################"

	_stop_service tiny-dfr.service

	# Unbind Audio to release apple-bce
	_unbind_device "0000:02:00.3" "Apple Audio device"
	# Remove Thunderbolt Controller
	_remove_device "0000:06:00.0" "Thunderbolt Controller"
	_unload_module thunderbolt

	_unload_module appletbdrm
	_unload_module hid_appletb_bl
	_unload_module hid_appletb_kbd
	_unload_module hci_bcm4377 2
	_unload_module brcmfmac_wcc 2
	_unload_module brcmfmac 2
	_unload_module apple-bce 4
}

function reload() {
	unload
	$cmd_sleep 10
	load
}

case "$1" in
load)
	load
	;;
unload)
	unload
	;;
reload)
	reload
	;;
version | v)
	echo "0.3"
	;;
*)
	echo "Usage: $0 load unload reload"
	exit 1
	;;
esac
