#!/usr/bin/env bash

if [ "$EUID" -ne 0 ]; then
	exec sudo "$(command -v \"$0\")" "$@"
fi

cmd_date=$(command -v date)
cmd_printf=$(command -v printf)
cmd_tee=$(command -v tee)
cmd_lsmod=$(command -v lsmod)
cmd_grep=$(command -v grep)
cmd_modprobe=$(command -v modprobe)
cmd_sleep=$(command -v sleep)
cmd_rmmod=$(command -v rmmod)
cmd_systemctl=$(command -v systemctl)
cmd_loginctl=$(command -v loginctl)
cmd_head=$(command -v head)
cmd_awk=$(command -v awk)
cmd_id=$(command -v id)

target_user=$($cmd_loginctl list-users --no-legend | $cmd_head -n 1 | $cmd_awk '{print $2}')
if [ -n "$target_user" ]; then
	target_UID=$($cmd_id -u "$target_user")
fi

log_file="$HOME/.cache/suspend-fix-t2.log"

function log() {
	local log_level="$1"
	local event_msg="$2"
	local timestamp
	timestamp=$($cmd_date "+%Y-%m-%d %H:%M:%S")
	local level_str="INFO"

	case "$log_level" in
	"-")
		level_str="ERROR"
		;;
	"!")
		level_str="WARNING"
		;;
	"*")
		level_str="INFO"
		;;
	"#")
		level_str="DEBUG"
		;;
	*)
		level_str="INFO"
		;;
	esac

	$cmd_printf "[$timestamp] [$level_str] $event_msg\n" | $cmd_tee --append "$log_file"
}

function _load_module() {
	local module_name="${1//-/_}"
	local delay="${2:-0.5}"
	local max_retries=3
	local attempt=1

	if $cmd_lsmod | $cmd_grep -q "^$module_name\s"; then
		log "#" "Module $1 is already loaded, skipping."
		return 0
	fi

	log "*" "Loading module $1..."
	while [ $attempt -le $max_retries ]; do
		if $cmd_modprobe "$1"; then
			log "*" "Module $1 loaded (Attempt $attempt)."
			log "*" "Waiting ${delay}s for initialization..."
			$cmd_sleep "$delay"
			return 0
		fi
		log "!" "Failed to load $1. Retrying in 1s... ($attempt/$max_retries)"
		$cmd_sleep 1
		((attempt++))
	done

	log "-" "CRITICAL: Failed to load module $1 after $max_retries attempts."
	return 1
}

function _unload_module() {
	local module_name="${1//-/_}"
	local delay="${2:-0.5}"
	local max_retries=5
	local attempt=1

	if ! $cmd_lsmod | $cmd_grep -q "^$module_name\s"; then
		log "#" "Module $1 is not loaded, skipping."
		return 0
	fi

	log "*" "Unloading module $1..."
	while [ $attempt -le $max_retries ]; do
		local res=0
		if [ "$1" == "apple-bce" ] || [ "$module_name" == "apple_bce" ]; then
			$cmd_rmmod "$1" 2>/dev/null || res=1
		else
			$cmd_modprobe --remove --remove-holders "$1" 2>/dev/null || res=1
		fi

		if [ $res -eq 0 ]; then
			# Verify it's actually gone
			if ! $cmd_lsmod | $cmd_grep -q "^$module_name\s"; then
				log "*" "Module $1 unloaded successfully (Attempt $attempt)."
				log "*" "Waiting ${delay}s for deinitialization..."
				$cmd_sleep "$delay"
				return 0
			fi
			
		fi

		log "!" "Module $1 busy or failed to unload. Retrying in 1s... ($attempt/$max_retries)"
		$cmd_sleep 1
		((attempt++))
	done

	log "-" "CRITICAL: Failed to unload module $1."
	return 1
}

function _stop_service() {
	local service_name=$1
	local user_mode=$2
	local ctl=$cmd_systemctl

	if [ "$user_mode" == "user" ]; then
		if [ -z "$target_user" ]; then
			log "!" "No active user found, skipping user service $service_name"
			return 0
		fi
		ctl="sudo -u $target_user XDG_RUNTIME_DIR=/run/user/$target_UID $cmd_systemctl --user"
	fi

	if $ctl is-active --quiet "$service_name"; then
		log "*" "Stopping $service_name..."
		$ctl stop "$service_name"
	fi
}

function _start_service() {
	local service_name=$1
	local wait_arg="${2:-wait}"
	local user_mode=$3
	local ctl=$cmd_systemctl
	local ctl_args=""

	if [ "$user_mode" == "user" ]; then
		if [ -z "$target_user" ]; then
			log "!" "No active user found, skipping user service $service_name"
			return 0
		fi
		ctl="sudo -u $target_user XDG_RUNTIME_DIR=/run/user/$target_UID $cmd_systemctl --user"
	fi

	if [ "$wait_arg" == "no-wait" ]; then
		ctl_args="--no-block"
	fi

	if ! $ctl is-active --quiet "$service_name"; then
		log "*" "Starting $service_name..."
		$ctl start $ctl_args "$service_name"
	else
		log "*" "$service_name is already running, restarting..."
		$ctl restart $ctl_args "$service_name"
	fi
}

function _rescan_PCI() {
	log "*" "Rescanning PCI bus..."
	if echo 1 > /sys/bus/pci/rescan; then
		log "*" "PCI rescan triggered successfully."
	else
		log "-" "Failed to trigger PCI rescan."
	fi
}

function _remove_device() {
	local device_id=$1
	local device_name="${2:-device $device_id}"
	local remove_path="/sys/bus/pci/devices/$device_id/remove"

	if [ -w "$remove_path" ]; then
		log "*" "Removing $device_name..."
		if echo 1 > "$remove_path" 2>/dev/null; then
			if [ ! -e "/sys/bus/pci/devices/$device_id" ]; then
				log "*" "Removed $device_name successfully."
				return 0
			fi
		fi
		log "-" "Failed to remove $device_name."
	else
		log "!" "$device_name not found, skipping removal."
	fi
}

function load() {
	log "_" "###########################"
	log "*" "Executing LOAD sequence..."
	log "_" "###########################"

	log "*" "PHASE 1: Root Modules"
	_load_module apple-bce 4
	
	log "*" "PHASE 2: Peripheral Modules"
	_load_module hid_appletb_bl
	_load_module hid_appletb_kbd
	_load_module appletbdrm
	_load_module brcmfmac 1
	_load_module brcmfmac_wcc 2
	_load_module hci_bcm4377 1
	
	log "*" "PHASE 3: Services & Hardware Wake"
	_start_service tiny-dfr.service no-wait
	_rescan_PCI
	
	log "*" "PHASE 4: Thunderbolt & Audio"
	_load_module thunderbolt

	_start_service pipewire.socket no-wait user
	_start_service pipewire.service no-wait user
	_start_service wireplumber.service no-wait user
	
	log "*" "LOAD sequence complete."
}

function unload() {
	log "_" "###########################"
	log "*" "Executing UNLOAD sequence..."
	log "_" "###########################"

	log "*" "PHASE 1: Stop Services"
	# Stop audio first to release drivers
	_stop_service wireplumber.service user
	_stop_service pipewire.service user
	_stop_service pipewire.socket user
	_stop_service tiny-dfr.service

	log "*" "PHASE 2: Hardware Teardown (Thunderbolt)"
	_remove_device "0000:06:00.0" "Thunderbolt Controller"
	_unload_module thunderbolt

	log "*" "PHASE 3: Unload Leaf Modules"
	_unload_module appletbdrm
	_unload_module hid_appletb_bl
	_unload_module hid_appletb_kbd
	_unload_module hci_bcm4377 2
	_unload_module brcmfmac_wcc 2
	_unload_module brcmfmac 2
	
	log "*" "PHASE 4: Unload Root Module"
	_unload_module apple-bce 4
	
	log "*" "UNLOAD sequence complete."
}

function reload() {
	unload
	$cmd_sleep 10
	load
}

case "$1" in
	load)
		load
		;;
	unload)
		unload
		;;
	reload)
		reload
		;;
	version | v)
		echo "0.4"
		;;
	*)
		echo "Usage: $0 load unload reload"
		exit 1
		;;
esac