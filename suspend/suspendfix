#!/usr/bin/env bash

if [ "$EUID" -ne 0 ]; then
    exec sudo "$(command -v "$0")" "$@"
fi

cmd_date=$(command -v date)
cmd_printf=$(command -v printf)
cmd_tee=$(command -v tee)
cmd_lsmod=$(command -v lsmod)
cmd_grep=$(command -v grep)
cmd_modprobe=$(command -v modprobe)
cmd_sleep=$(command -v sleep)
cmd_rmmod=$(command -v rmmod)
cmd_systemctl=$(command -v systemctl)

log_file="$HOME/.cache/suspend-fix-t2.log"

function log() {
	local log_level="$1"
	local event_msg="$2"
	local timestamp
	timestamp=$($cmd_date "+%Y-%m-%d %H:%M:%S")
	local level_str="INFO"

	case "$log_level" in
	"-")
		level_str="CRITICAL"
		;;
	"!")
		level_str="ERROR"
		;;
	"*")
		level_str="WARNING"
		;;
	"+")
		level_str="INFO"
		;;
	"#")
		level_str="DEBUG"
		;;
	*)
		level_str="INFO"
		;;
	esac

	$cmd_printf "[$timestamp] [$level_str] $event_msg\n" | $cmd_tee --append "$log_file"
}

function _load_module() {
	module_name="${1//-/_}"
	delay="${2:-0.5}"

	if $cmd_lsmod | $cmd_grep -q "^$module_name\\s"; then
		log "*" "Module $1 is already loaded."
		return 0
	fi

	log "#" "Module $1 is not loaded. Loading..."
	$cmd_modprobe "$1"
	log "#" "Waiting ${delay}s for initialization..."
	$cmd_sleep "$delay"

	if $cmd_lsmod | $cmd_grep -q "^$module_name\\s"; then
		log "+" "Module $1 loaded successfully."
		return 0
	fi

	log "!" "Failed to load module $1."
	return 1
}

function _unload_module() {
	module_name="${1//-/_}"
	delay="${2:-0.5}"

	if ! $cmd_lsmod | $cmd_grep -q "^$module_name\\s"; then
		log "*" "Module $1 is not loaded, skipping."
		return 0
	fi

	log "#" "Module $1 is loaded. Unloading..."
	if [ "$1" == "apple-bce" ] || [ "$module_name" == "apple_bce" ]; then
		$cmd_rmmod "$1"
	else
		$cmd_modprobe --remove --remove-holders "$1"
	fi

	log "#" "Waiting ${delay}s for deinitialization..."
	$cmd_sleep "$delay"

	if ! $cmd_lsmod | $cmd_grep -q "^$module_name\\s"; then
		log "+" "Module $1 unloaded successfully."
		return 0
	fi

	log "!" "Failed to unload module $1."
	return 1
}

function _stop_service() {
	service_name=$1
	if $cmd_systemctl is-active --quiet "$service_name"; then
		log "+" "Stopping $service_name..."
		log "_" "###########################"
		$cmd_systemctl stop "$service_name"
	fi
}

function _start_service() {
	service_name=$1
	wait_arg="${2:-wait}"

	ctl_args=""
	if [ "$wait_arg" == "no-wait" ]; then
		ctl_args="--no-block"
	fi

	if ! $cmd_systemctl is-active --quiet "$service_name"; then
		log "+" "Starting $service_name..."
		log "_" "###########################"
		$cmd_systemctl start $ctl_args "$service_name"
	else
		log "_" "###########################"
		log "#" "$service_name is already running, Restarting..."
		log "+" "Restarting $service_name..."
		log "_" "###########################"
		$cmd_systemctl restart $ctl_args "$service_name"
	fi
}

function load() {
	log "_" "###########################"
	log "+" "Executing load sequence..."
	log "_" "###########################"

	_load_module apple-bce 4
	_load_module hid_appletb_bl 0.5
	_load_module hid_appletb_kbd 0.5
	_load_module appletbdrm 0.5
	_load_module brcmfmac_wcc 1
	_load_module brcmfmac 0.5
	_load_module hci_bcm4377 1
	_start_service tiny-dfr.service no-wait

	log "#" "Rescanning PCI bus..."
	echo 1 > /sys/bus/pci/rescan
	_load_module thunderbolt
}

function unload() {
	log "_" "###########################"
	log "+" "Executing unload sequence..."
	log "_" "###########################"

	_stop_service tiny-dfr.service

	# Unbind Audio to release apple-bce
	log "#" "Unbinding Apple Audio device..."
	echo "0000:02:00.3" > /sys/bus/pci/drivers/aaudio/unbind 2>/dev/null || true

	if [ -d "/sys/bus/pci/devices/0000:06:00.0" ]; then
		log "#" "Removing Thunderbolt Controller..."
		echo 1 > /sys/bus/pci/devices/0000:06:00.0/remove
	fi
	_unload_module thunderbolt

	_unload_module appletbdrm
	_unload_module hid_appletb_bl
	_unload_module hid_appletb_kbd
	_unload_module brcmfmac_wcc
	_unload_module brcmfmac
	_unload_module hci_bcm4377 2
	_unload_module apple-bce 4
}

function reload() {
	unload
	$cmd_sleep 5
	load
}

case "$1" in
load)
	load
	;;
unload)
	unload
	;;
reload)
	reload
	;;
version | v)
	echo "0.2-1"
	;;
*)
	echo "Usage: $0 load unload reload"
	exit 1
	;;
esac